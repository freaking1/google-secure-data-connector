

%preun

%pre 

%prep 
#%setup -c -n %{name}-%{version} 

%build
#ant binary-distro 

%install
rm -rf $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT
mkdir -p $RPM_BUILD_ROOT/opt/%{name}
mkdir -p $RPM_BUILD_ROOT/opt/%{name}/lib
mkdir -p $RPM_BUILD_ROOT/opt/%{name}/bin
mkdir -p $RPM_BUILD_ROOT/etc/opt/%{name}
mkdir -p $RPM_BUILD_ROOT/etc/opt/%{name}/woodstock-user/.ssh
mkdir -p $RPM_BUILD_ROOT/etc/opt/%{name}/openssh
# mkdir -p $RPM_BUILD_ROOT/etc/opt/%{name}/jsw
tar -xzf $RPM_SOURCE_DIR/%{name}-%{version}-%{release}-bin.tar.gz -C $RPM_BUILD_ROOT/opt/%{name}

# Moving config files for ssh
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/sshd_config $RPM_BUILD_ROOT/etc/opt/%{name}/openssh/sshd_config
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/start_sshd.sh $RPM_BUILD_ROOT/etc/opt/%{name}/openssh/start_sshd.sh
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/ssh_host_rsa_key $RPM_BUILD_ROOT/etc/opt/%{name}/openssh
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/ssh_host_dsa_key $RPM_BUILD_ROOT/etc/opt/%{name}/openssh
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/ssh_host_rsa_key.pub $RPM_BUILD_ROOT/etc/opt/%{name}/openssh
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/ssh_host_dsa_key.pub $RPM_BUILD_ROOT/etc/opt/%{name}/openssh

# Moving config files for /etc/opt/${name}
mv $RPM_BUILD_ROOT/opt/%{name}/config/localConfig.xml $RPM_BUILD_ROOT/etc/opt/%{name}/localConfig.xml
mv $RPM_BUILD_ROOT/opt/%{name}/config/resourceRules.xml-dist $RPM_BUILD_ROOT/etc/opt/%{name}/resourceRules.xml
mv $RPM_BUILD_ROOT/opt/%{name}/config/apache $RPM_BUILD_ROOT/etc/opt/%{name}

# Moving woodstock-user ssh authorized_keys file
mv $RPM_BUILD_ROOT/opt/%{name}/config/openssh/woodstock-authorized_keys $RPM_BUILD_ROOT/etc/opt/%{name}/woodstock-user/.ssh/authorized_keys

# Removing source config directory
rm -rf $RPM_BUILD_ROOT/opt/%{name}/config

%post 
set -e
USER=daemon
CONF_DIR="/etc/opt/${name}"
CLIENT_HOME="/opt/${name}"
LOGDIR="/var/log/${name}"
WOODSTOCK_HOME=CONF_DIR/woodstock-user"

# Create default apache log and htdocs directories
mkdir -p $CONF_DIR/apache/htdocs
mkdir -p $CLIENT_HOME/logs

# Set up the user to access the client
adduser -s /bin/false -U -d $WOODSTOCK_HOME -M \
woodstock

dd if=/dev/urandom bs=1024 count=1 |passwd --stdin woodstock

# Set up the logfile for $%{name}
  if [ ! -d $LOGDIR ]; then
    mkdir $LOGDIR
  fi
  chown root:$%{name} $LOGDIR
  chmod 770 $LOGDIR
  for filename in "$%{name}" "apache_access_log" "apache_error_log"; do
    logfile="$LOGDIR/$filename"
    if [ ! -f $logfile ]; then
      touch $logfile
    fi
    chown root:$USER $logfile
    chmod 660 $logfile
  done


# Set permissions on installation for user accounts
chown -R root:$USER /etc/opt/${name}
chown -R root:$UUSER /opt/${name}
chmod 755 /etc/opt/${name}

# Set permission on ssh keys and scripts
chmod 644 $WOODSTOCK_HOME/.ssh/authorized_keys
chmod 750 $CONF_DIR/openssh/start_sshd.sh
 
%postun
echo "Removing User Accounts.."

userdel -r woodstock || true

if [ -e /opt/${name} ] ; then
 rm -rf /opt/${name} 
fi

# if [ -e /etc/init.d/dataconnector ] ; then
# rm -f /etc/init.d/dataconnector
# fi

%clean                               
rm -rf $RPM_BUILD_ROOT

%files
%defattr(-,root,dataconnector) 
%config /etc/opt/%{name}/apache/httpd.conf-template
%config /etc/opt/%{name}/resourceRules.xml
%config /etc/opt/%{name}/localConfig.xml
/etc/opt/%{name}/*
/opt/%{name}/*  


